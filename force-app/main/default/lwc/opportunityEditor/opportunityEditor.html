<template>
  <!-- Modal para edição da oportunidade -->
  <template if:true={showModal}>
    <section
      role="dialog"
      tabindex="-1"
      aria-labelledby="opportunity-modal-heading"
      aria-modal="true"
      aria-describedby="opportunity-modal-content"
      class="slds-modal slds-fade-in-open"
    >
      <div class="slds-modal__container">
        <!-- Modal Header -->
        <header class="slds-modal__header">
          <lightning-button-icon
            class="slds-modal__close"
            title="Fechar"
            icon-name="utility:close"
            variant="bare"
            alternative-text="Fechar"
            onclick={closeModal}
          ></lightning-button-icon>
          <h2
            id="opportunity-modal-heading"
            class="slds-modal__title slds-hyphenate"
          >
            <lightning-icon
              icon-name="standard:opportunity"
              size="small"
              class="slds-m-right_small"
            ></lightning-icon>
            {opportunityName}
          </h2>
          <p class="slds-m-top_x-small">
            Preencha os detalhes da oportunidade criada para o lead convertido
          </p>
        </header>

        <!-- Modal Body -->
        <div
          class="slds-modal__content slds-p-around_medium"
          id="opportunity-modal-content"
        >
          <div
            if:true={isLoading}
            class="slds-is-relative slds-p-around_medium"
          >
            <lightning-spinner
              alternative-text="Carregando..."
              variant="brand"
              size="small"
            ></lightning-spinner>
          </div>

          <template if:false={isLoading}>
            <template if:true={opportunityError}>
              <div
                class="slds-notify slds-notify_alert slds-alert_error"
                role="alert"
              >
                <lightning-icon
                  icon-name="utility:error"
                  size="small"
                  class="slds-m-right_small"
                ></lightning-icon>
                <h2>{opportunityError}</h2>
              </div>
            </template>

            <template if:true={opportunityDetails}>
              <div class="slds-form" role="list">
                <!-- Nome da oportunidade oculto visualmente, mas mantido no DOM -->
                <div class="slds-hide">
                  <lightning-input
                    label="Nome da Oportunidade"
                    name="opportunityName"
                    value={opportunityName}
                    onchange={handleFieldChange}
                    required
                    disabled
                  ></lightning-input>
                </div>

                <!-- Campo de Valor -->
                <div class="slds-form__row">
                  <div class="slds-form__item slds-size_1-of-1" role="listitem">
                    <div class="slds-form-element slds-form-element_stacked">
                      <lightning-input
                        type="number"
                        label="Valor (R$)"
                        name="opportunityAmount"
                        value={opportunityAmount}
                        onchange={handleFieldChange}
                        formatter="currency"
                        format-style="currency"
                        step="0.01"
                      ></lightning-input>
                    </div>
                  </div>
                </div>
                
                <!-- Campo de Data de Fechamento -->
                <div class="slds-form__row">
                  <div class="slds-form__item slds-size_1-of-1" role="listitem">
                    <div class="slds-form-element slds-form-element_stacked">
                      <lightning-input
                        type="date"
                        label="Data de Fechamento"
                        name="opportunityCloseDate"
                        value={opportunityCloseDate}
                        onchange={handleFieldChange}
                        required
                      ></lightning-input>
                    </div>
                  </div>
                </div>
                
                <!-- Estágio oculto visualmente, mas mantido no DOM para o JavaScript funcionar -->
                <div class="slds-hide">
                  <lightning-combobox
                    label="Estágio"
                    name="opportunityStageName"
                    value={opportunityStageName}
                    options={stageOptions}
                    onchange={handleFieldChange}
                    required
                  ></lightning-combobox>
                </div>

                <div class="slds-form__row">
                  <div class="slds-form__item slds-size_1-of-1" role="listitem">
                    <div class="slds-form-element slds-form-element_stacked">
                      <label class="slds-form-element__label">Tipo</label>
                      <div class="slds-form-element__control">
                        <div class="type-card-container vertical-cards">
                          <!-- Card para Liquidação Otimizada -->
                          <div class={liquidacaoOtimizadaClass} data-type="Liquidação Otimizada" onclick={handleTypeCardClick}>
                            <div class="type-card-content">
                              <lightning-icon icon-name="utility:money" size="medium"></lightning-icon>
                              <div class="type-card-label">Liquidação Otimizada</div>
                            </div>
                          </div>
                          
                          <!-- Card para Consultoria Societária -->
                          <div class={consultoriaSocietariaClass} data-type="Consultoria Societária" onclick={handleTypeCardClick}>
                            <div class="type-card-content">
                              <lightning-icon icon-name="utility:groups" size="medium"></lightning-icon>
                              <div class="type-card-label">Consultoria Societária</div>
                            </div>
                          </div>
                          
                          <!-- Card para Gestão de Patrimônio -->
                          <div class={gestaoPatrimonioClass} data-type="Gestão de Patrimônio" onclick={handleTypeCardClick}>
                            <div class="type-card-content">
                              <lightning-icon icon-name="utility:chart" size="medium"></lightning-icon>
                              <div class="type-card-label">Gestão de Patrimônio</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="slds-form__row">
                  <div class="slds-form__item slds-size_1-of-1" role="listitem">
                    <div class="slds-form-element slds-form-element_stacked">
                      <label class="slds-form-element__label slds-text-title_caps">Probabilidade da Oportunidade</label>
                      <div class="slds-form-element__control probability-slider-container">
                        <c-range-slider
                          name="opportunityProbability"
                          value={opportunityProbabilityNumericValue}
                          disabled={isLoading}
                          onvaluechange={handleRangeSliderChange}
                          onchange={handleRangeSliderFinalChange}
                        ></c-range-slider>
                                                <div class="slds-m-top_medium">
                           <div class="custom-accordion">
                              <div class="custom-accordion-item">
                                <div class="custom-accordion-header" onclick={toggleAccordion} data-name="fibonacci">
                                  <h3 class="custom-accordion-title">Como a probabilidade é calculada?</h3>
                                  <lightning-icon 
                                    icon-name="utility:chevrondown" 
                                    size="x-small" 
                                    class="custom-accordion-icon"
                                    alternative-text="Expandir/Recolher"
                                  ></lightning-icon>
                                </div>
                                <div class="custom-accordion-content" data-name="fibonacci">
                                  <div class="slds-text-body_small slds-p-around_small slds-box slds-theme_shade">
                                    <p class="slds-m-bottom_small">
                                      <strong>Sequência de Fibonacci aplicada à probabilidade</strong>
                                    </p>
                                    <p class="slds-m-bottom_x-small">
                                      Os valores de probabilidade (0%, 13%, 34%, 55%, 89%, 100%) são baseados na sequência de Fibonacci, que representa uma aproximação de confiança na concretização da oportunidade:
                                    </p>
                                    <ul class="slds-list_dotted slds-m-left_medium slds-m-bottom_small">
                                      <li><strong>0%</strong> - Sem chance de concretização.</li>
                                      <li><strong>13%</strong> - Contato inicial: cliente demonstrou interesse básico.</li>
                                      <li><strong>34%</strong> - Qualificação: necessidades identificadas, proposta em elaboração.</li>
                                      <li><strong>55%</strong> - Proposta aceita: negociação de detalhes.</li>
                                      <li><strong>89%</strong> - Fechamento iminente: documentação em andamento.</li>
                                      <li><strong>100%</strong> - Negócio fechado e confirmado.</li>
                                    </ul>
                                    <p class="slds-m-bottom_small">
                                      <em>Nota: Estas são aproximações baseadas em padrões de progressão natural encontrados na sequência matemática de Fibonacci, não representam garantias absolutas de fechamento de negócio.</em>
                                    </p>
                                    <p>
                                      Por exemplo, uma oportunidade com 55% reflete que o cliente aceitou a proposta principal, mas ainda existem detalhes a serem acertados antes da assinatura final do contrato.
                                    </p>
                                  </div>
                                </div>
                              </div>
                            </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="slds-form__row">
                  <div class="slds-form__item" role="listitem">
                    <div class="slds-form-element slds-form-element_stacked">
                      <!-- Container de pílulas de templates de descrição (estilo sidebarChamada) -->
                      <div class="pills-container">
                        <div class="pills-heading">
                          <lightning-icon
                            icon-name="utility:description"
                            size="x-small"
                            class="slds-m-right_x-small"
                          ></lightning-icon>
                          Adicionar descrição
                        </div>
                        <div class="pills-wrapper">
                          <!-- Pílula para cada template de descrição -->
                          <div class="message-pill" data-value="zero" onclick={handleTemplateCardClick}>
                            0% - Sem chance
                          </div>
                          <div class="message-pill" data-value="treze" onclick={handleTemplateCardClick}>
                            13% - Contato inicial
                          </div>
                          <div class="message-pill" data-value="trintaequatro" onclick={handleTemplateCardClick}>
                            34% - Qualificação
                          </div>
                          <div class="message-pill" data-value="cinquentaecinco" onclick={handleTemplateCardClick}>
                            55% - Proposta aceita
                          </div>
                          <div class="message-pill" data-value="oitentaenove" onclick={handleTemplateCardClick}>
                            89% - Fechamento iminente
                          </div>
                          <div class="message-pill" data-value="cem" onclick={handleTemplateCardClick}>
                            100% - Negócio fechado
                          </div>
                        </div>
                      </div>
                      <lightning-textarea
                        label="Descrição"
                        name="opportunityDescription"
                        value={opportunityDescription}
                        onchange={handleFieldChange}
                        placeholder="Adicione informações importantes sobre a oportunidade..."
                      ></lightning-textarea>
                    </div>
                  </div>
                </div>

                <div class="slds-form__row slds-m-top_medium">
                  <div class="slds-form__item" role="listitem">
                    <div
                      class="slds-box slds-theme_info slds-theme_alert-texture"
                    >
                      <div class="slds-media">
                        <div class="slds-media__figure">
                          <lightning-icon
                            icon-name="utility:info"
                            size="small"
                          ></lightning-icon>
                        </div>
                        <div class="slds-media__body">
                          <p>
                            Esta oportunidade foi criada automaticamente quando
                            o lead foi convertido em cliente.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </template>
        </div>

        <!-- Modal Footer -->
        <footer class="slds-modal__footer">
          <lightning-button
            label="Visualizar"
            icon-name="utility:preview"
            onclick={navigateToOpportunity}
            class="slds-m-right_small"
          >
          </lightning-button>
          <lightning-button
            label="Salvar"
            variant="brand"
            onclick={saveOpportunity}
            disabled={isLoading}
          >
          </lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>
</template>